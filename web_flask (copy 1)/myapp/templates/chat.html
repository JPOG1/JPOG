<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Window</title>
    <!-- Link to Bootstrap for responsive design and styling -->
    <link
      href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
      rel="stylesheet"
      id="bootstrap-css"
    />
    <!-- Link to your custom chat styles -->
    <link rel="stylesheet" href="/static/chat.css" />
    <!-- Script to load Bootstrap JS -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <!-- jQuery script (required for Bootstrap and other interactions) -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Font Awesome for icons (e.g., the search icon and send button) -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"
      rel="stylesheet"
    />
    <!-- Socket.IO script for real-time messaging -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <style>
    body {
      background-image: url();
    }
    
  </style>
  <body>
    <div class="container">
      <!-- Header showing the username, chat title, and email -->
      <div class="container-header">
        <h3 class="text-left">{{ user_data["username"] }}</h3>
        <h3 class="text-center">Omze_Chat</h3>
        <h3 class="text-right">{{ user_data["email"] }}</h3>
      </div>
      <div class="messaging">
        <div class="inbox_msg">
          {% if username==Ogogo%}
          <!-- Left section with list of recent chats -->
          <div class="inbox_people">
            <div class="headind_srch">
              <!-- Heading for the recent chats list -->
              <div class="recent_heading">
                <h4>Recent</h4>
              </div>
              <!-- Search bar for searching chats -->
              <div class="srch_bar">
                <div class="stylish-input-group">
                  <input type="text" class="search-bar" placeholder="Search" />
                  <span class="input-group-addon">
                    <button type="button">
                      <i class="fa fa-search" aria-hidden="true"></i>
                    </button>
                  </span>
                </div>
              </div>
              <!-- Button to start a new chat, with form input for the email -->
              <div class="new_chat">
                <div id="new_chat_overlay"></div>
                <button id="new_chat_btn">
                  <i class="fa fa-plus"></i> New Chat
                </button>
                <form
                  method="POST"
                  action="{{ url_for('views.new_chat') }}"
                  id="new_chat_form"
                >
                  <!-- <label for="email"><strong>Email: </strong></label>
                  <input
                    type="email"
                    value="jpaulogirima156@gmail.com"
                    name="email"
                    placeholder="enter friend's email here..."
                  /> -->
                  <ul>
                    <li class="li" name="email">
                      <img
                        src="/images/BackgroundEraser_20240923_142243978-removebg-preview (1).png"
                        alt="sunil"
                        style="border: solid 1px blue; border-radius: 90px; width: 20px; height: 20px;"
                      />
                      <input
                      type="email"
                      value="jpaulogirima156@gmail.com"
                      name="email"
                      style="width: 0;"
                      placeholder="enter friend's email here..."
                    />

                      <span style="color: blue;">Omze Customer care</span>
                    </li>
                  </ul>
                  <input type="submit" value="Submit" />
                </form>
              </div>
            </div>
            <!-- Display list of existing chat rooms -->
            <div class="inbox_chat">
              {% for i in data %}
              <a href="{{ url_for('views.chat', rid=i.room_id) }}">
                <div class="chat_list" id="{{ i.room_id }}">
                  <div class="chat_people">
                    <div class="chat_img">
                      <img
                        src="https://ptetutorials.com/images/user-profile.png"
                        alt="sunil"
                      />
                    </div>
                    <div class="chat_ib">
                      <h5>{{ i["email"] }}</h5>
                      <p id="last-message">{{ i["last_message"] }}</p>
                    </div>
                  </div>
                </div>
              </a>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Right section for the actual chat messages -->
          <div class="mesgs">
            <div class="msg_history">
              {% for j in messages %} {% if j.sender_username ==
              user_data["username"] %}
              <!-- Displaying outgoing message (user's message) -->
              <div class="outgoing_msg" id="{{ j.timestamp }}">
                <div class="sent_msg">
                  <p>{{ j.content }}</p>
                  <span class="time_date">{{ j.timestamp | ftime }}</span>
                </div>
              </div>
              {% else %}
              <!-- Displaying incoming message (someone else's message) -->
              <div class="incoming_msg" id="{{ j.timestamp }}">
                <div class="incoming_msg_img">
                  <img
                    src="https://ptetutorials.com/images/user-profile.png"
                    alt="sunil"
                  />
                </div>
                <div class="received_msg">
                  <div class="received_withd_msg">
                    <p>{{ j.content }}</p>
                    <span class="time_date">{{ j.timestamp | ftime }}</span>
                  </div>
                </div>
              </div>
              {% endif %} {% endfor %}
            </div>
            <!-- Input area to type and send a message -->
            <div class="type_msg">
              <div class="input_msg_write">
                <form id="chat_form">
                  <input
                    type="text"
                    class="message"
                    placeholder="Type a message"
                  />
                  <button class="msg_send_btn" type="submit">
                    <i class="fa fa-paper-plane-o" aria-hidden="true"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <p class="text-center top_spac">
          Design by
          <a target="_blank" href="#">NETA</a>
        </p>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <script type="text/javascript">
      // Initialize message history and set scroll position
      let msgH = document.querySelectorAll(".msg_history > div"), CurrentLen;
      let init = () => {
        CurrentLen = msgH.length; // Track initial length
      }
      init();
      let validatePosition = () => {
        if (msgH.length === CurrentLen) {
          msgH[msgH.length - 1].setAttribute("id", "last_message");
          // Ensure last message is always tagged for scrolling
        }
      }
      let scrollDown = () => {
        validatePosition();
        location.href = "#last_message"; // Scroll to the last message
        init(); // Reinitialize message history length
      }

      // SOCKET.IO Setup
      var socket = io.connect('http://' + document.domain + ':' + location.port + '/?rid=' + {{ room_id }} );
      socket.on('connect', function () {
        socket.emit('join-chat', {
          rid: '{{ room_id }}' // Join the room on socket connection
        })
      })

      socket.on('joined-chat', function (msg) {
        console.log(msg); // Log when a user joins a chat room
      })

      // Handle the message submission via Socket.IO
      var form = $('#chat_form').on('submit', function (e) {
        e.preventDefault(); // Prevent form from refreshing the page
        let user_input = $('input.message').val(); // Get the message from input

        // Send message via Socket.IO to the server
        socket.emit('outgoing', {
          timestamp: parseInt(Date.now() / 1000),
          sender_username: "{{ user_data['username'] }}",
          sender_id: {{ user_data["id"] }},
          message: user_input,
          rid: '{{ room_id }}'
        });

        // Append the outgoing message to the chat history
        $('div.msg_history').append(`
              <div class="outgoing_msg">
                <div class="sent_msg">
                  <p>${user_input}</p>
                  <span class="time_date"> ${formatDate(new Date())}</span> </div>
              </div>
            `);
        // Update the last message content
        document.getElementById("last-message").innerHTML = user_input;
        $('input.message').val('').focus(); // Clear the input field
        scrollDown(); // Scroll to the bottom after sending
      });

      // Listen for incoming messages
      socket.on('message', function (msg) {
        // Handle incoming messages, format them and append to history
        if (msg.sender_username === "Ogogo") {
          // If message is from Ogogo, force it to show on the left (incoming)
          $('div.msg_history').append(`
            <div class="incoming_msg">
              <div class="incoming_msg_img">
                <img src="https://ptetutorials.com/images/user-profile.png" alt="Ogogo">
              </div>
              <div class="received_msg">
                <div class="received_withd_msg">
                  <p>${msg.message}</p>
                  <span class="time_date"> ${formatDate(new Date())}</span>
                </div>
              </div>
            </div>`);
        } else {
          // Normal incoming message
          $('div.msg_history').append(`
            <div class="incoming_msg">
              <div class="incoming_msg_img">
                <img src="https://ptetutorials.com/images/user-profile.png" alt="user">
              </div>
              <div class="received_msg">
                <div class="received_withd_msg">
                  <p>${msg.message}</p>
                  <span class="time_date"> ${formatDate(new Date())}</span>
                </div>
              </div>
            </div>`);
        }
        scrollDown(); // Scroll down to the last message
        document.getElementById("last-message").innerHTML = msg.message; // Update the last message
      })
    </script>

    <!-- Function to format time -->
    <script>
      function formatDate(date) {
        const hours = date.getHours();
        let formattedHours;
        if (hours > 12) {
          formattedHours = hours - 12;
        } else if (hours === 0) {
          formattedHours = 12;
        } else {
          formattedHours = hours;
        }
        const minutes = date.getMinutes();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const timeFormat = `${formattedHours}:${minutes} ${
          hours >= 12 ? "PM" : "AM"
        } | ${month}/${day}`;
        return timeFormat;
      }
    </script>

    <!-- Script to handle new chat form -->
    <script>
      window.onload = function () {
        let newChatBtn = document.querySelector("#new_chat_btn");
        let newChatForm = document.querySelector("#new_chat_form");
        let newChatoverlay = document.querySelector("#new_chat_overlay");
        newChatBtn.onclick = (e) => {
          if (e.target === newChatBtn) {
            newChatForm.style.display = "block";
            newChatoverlay.style.display = "block";
          }
        };
        newChatoverlay.onclick = (e) => {
          if (e.target === newChatoverlay) {
            newChatForm.style.display = "none";
            newChatoverlay.style.display = "none";
          }
        };
      };
    </script>
  </body>
</html>
